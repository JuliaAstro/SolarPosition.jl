<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Building models with ModelingToolkit.jl · SolarPosition.jl</title><meta name="title" content="Building models with ModelingToolkit.jl · SolarPosition.jl"/><meta property="og:title" content="Building models with ModelingToolkit.jl · SolarPosition.jl"/><meta property="twitter:title" content="Building models with ModelingToolkit.jl · SolarPosition.jl"/><meta name="description" content="Documentation for SolarPosition.jl."/><meta property="og:description" content="Documentation for SolarPosition.jl."/><meta property="twitter:description" content="Documentation for SolarPosition.jl."/><meta property="og:url" content="https://juliaastro.org/SolarPosition/stable/guides/modelingtoolkit/"/><meta property="twitter:url" content="https://juliaastro.org/SolarPosition/stable/guides/modelingtoolkit/"/><link rel="canonical" href="https://juliaastro.org/SolarPosition/stable/guides/modelingtoolkit/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SolarPosition.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Guides</span><ul><li><a class="tocitem" href="../getting-started/">Getting Started</a></li><li><a class="tocitem" href="../plotting/">Plotting with Makie.jl</a></li><li><a class="tocitem" href="../parallel/">Parallel Computing with OhMyThreads.jl</a></li><li class="is-active"><a class="tocitem" href>Building models with ModelingToolkit.jl</a><ul class="internal"><li><a class="tocitem" href="#Installation"><span>Installation</span></a></li><li><a class="tocitem" href="#Quick-Start"><span>Quick Start</span></a></li><li><a class="tocitem" href="#SolarPositionBlock"><span>SolarPositionBlock</span></a></li><li><a class="tocitem" href="#Composing-with-Other-Systems"><span>Composing with Other Systems</span></a></li><li><a class="tocitem" href="#Implementation-Details"><span>Implementation Details</span></a></li><li><a class="tocitem" href="#Limitations"><span>Limitations</span></a></li><li><a class="tocitem" href="#See-Also"><span>See Also</span></a></li></ul></li><li><a class="tocitem" href="../new-algorithm/">Adding a New Solar Position Algorithm</a></li></ul></li><li><a class="tocitem" href="../../reference/">API reference</a></li><li><a class="tocitem" href="../../positioning/">Solar Positioning</a></li><li><a class="tocitem" href="../../refraction/">Refraction Correction</a></li><li><a class="tocitem" href="../../deltat/">Delta T (ΔT)</a></li><li><a class="tocitem" href="../../literature/">Literature</a></li><li><a class="tocitem" href="../../contributing/">Contributing guidelines</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Guides</a></li><li class="is-active"><a href>Building models with ModelingToolkit.jl</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Building models with ModelingToolkit.jl</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaAstro/SolarPosition.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaAstro/SolarPosition.jl/blob/main/docs/src/guides/modelingtoolkit.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Building-models-with-ModelingToolkit.jl"><a class="docs-heading-anchor" href="#Building-models-with-ModelingToolkit.jl">Building models with ModelingToolkit.jl</a><a id="Building-models-with-ModelingToolkit.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Building-models-with-ModelingToolkit.jl" title="Permalink"></a></h1><p>SolarPosition.jl provides a <a href="https://github.com/SciML/ModelingToolkit.jl"><code>ModelingToolkit.jl</code></a> extension that enables integration of solar position calculations into symbolic modeling workflows. This allows you to compose solar position components with other physical systems for applications like solar energy modeling, building thermal analysis, and solar tracking systems.</p><h2 id="Installation"><a class="docs-heading-anchor" href="#Installation">Installation</a><a id="Installation-1"></a><a class="docs-heading-anchor-permalink" href="#Installation" title="Permalink"></a></h2><p>The ModelingToolkit extension is loaded automatically when both <a href="https://github.com/JuliaAstro/SolarPosition.jl"><code>SolarPosition.jl</code></a> and <a href="https://github.com/SciML/ModelingToolkit.jl"><code>ModelingToolkit.jl</code></a> are loaded:</p><pre><code class="language-julia hljs">using SolarPosition
using ModelingToolkit</code></pre><h2 id="Quick-Start"><a class="docs-heading-anchor" href="#Quick-Start">Quick Start</a><a id="Quick-Start-1"></a><a class="docs-heading-anchor-permalink" href="#Quick-Start" title="Permalink"></a></h2><p>The extension provides the <a href="#SolarPositionBlock"><code>SolarPositionBlock</code></a> component, which outputs solar azimuth, elevation, and zenith angles as time-varying quantities.</p><pre><code class="language-julia hljs">using SolarPosition
using ModelingToolkit
using ModelingToolkit: t_nounits as t
using Dates
using OrdinaryDiffEq</code></pre><pre><code class="language-julia hljs"># Create a solar position block
@named sun = SolarPositionBlock()

# Define observer location and reference time
obs = Observer(51.50274937708521, -0.17782150375214803, 15.0)  # Natural History Museum
t0 = DateTime(2024, 6, 21, 12, 0, 0)  # Summer solstice noon

# Compile the system
sys = mtkcompile(sun)

# Set parameters using the compiled system&#39;s parameter references
pmap = [
    sys.observer =&gt; obs,
    sys.t0 =&gt; t0,
    sys.algorithm =&gt; PSA(),
    sys.refraction =&gt; NoRefraction(),
]

# Solve over 24 hours (time in seconds)
tspan = (0.0, 86400.0)
prob = ODEProblem(sys, pmap, tspan)
sol = solve(prob; saveat = 3600.0)  # Save every hour

# Show some results
println(&quot;Solar position at noon (t=12 hours):&quot;)
println(&quot;  Azimuth: &quot;, round(sol[sys.azimuth][1], digits=2), &quot;°&quot;)
println(&quot;  Elevation: &quot;, round(sol[sys.elevation][1], digits=2), &quot;°&quot;)
println(&quot;  Zenith: &quot;, round(sol[sys.zenith][1], digits=2), &quot;°&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Solar position at noon (t=12 hours):
  Azimuth: 178.72°
  Elevation: 61.93°
  Zenith: 28.07°</code></pre><h2 id="SolarPositionBlock"><a class="docs-heading-anchor" href="#SolarPositionBlock">SolarPositionBlock</a><a id="SolarPositionBlock-1"></a><a class="docs-heading-anchor-permalink" href="#SolarPositionBlock" title="Permalink"></a></h2><p>The <a href="#SolarPositionBlock"><code>SolarPositionBlock</code></a> is a <a href="https://github.com/SciML/ModelingToolkit.jl"><code>ModelingToolkit.jl</code></a> component that computes solar position angles based on time, observer location, and chosen positioning and refraction algorithms.</p><article><details class="docstring" open="true"><summary id="SolarPosition.SolarPositionBlock"><a class="docstring-binding" href="#SolarPosition.SolarPositionBlock"><code>SolarPosition.SolarPositionBlock</code></a> — <span class="docstring-category">Function</span></summary><section><div><p>Return a <a href="https://github.com/SciML/ModelingToolkit.jl"><code>ModelingToolkit.jl</code></a> component that computes solar position as a function of time and can be integrated into symbolic modeling workflows.</p><p>The <a href="#SolarPositionBlock"><code>SolarPositionBlock</code></a> is a <a href="https://docs.sciml.ai/ModelingToolkit/stable/API/System/#ModelingToolkit.System"><code>System</code></a> which exposes <code>azimuth</code>, <code>elevation</code>, and <code>zenith</code> as output variables computed from the simulation time <code>t</code> (in seconds) relative to a reference time <code>t0</code>.</p><div class="admonition is-info" id="Note-62f252467ac05dcc"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-62f252467ac05dcc" title="Permalink"></a></header><div class="admonition-body"><p>This function requires <a href="https://github.com/SciML/ModelingToolkit.jl"><code>ModelingToolkit.jl</code></a> to be loaded. The extension is automatically loaded when both <a href="https://github.com/JuliaAstro/SolarPosition.jl">SolarPosition.jl</a> and <a href="https://github.com/SciML/ModelingToolkit.jl"><code>ModelingToolkit.jl</code></a> are available.</p></div></div><p><strong>Parameters</strong></p><ul><li><code>observer::Observer</code>: location (latitude, longitude, altitude). See <a href="../../reference/#SolarPosition.Positioning.Observer"><code>Observer</code></a></li><li><code>t0::DateTime</code>: Reference time (time when simulation time <code>t = 0</code>)</li><li><code>algorithm::SolarAlgorithm</code>: Solar positioning algorithm (default: <a href="../../positioning/#SolarPosition.Positioning.PSA"><code>PSA</code></a>)</li><li><code>refraction::RefractionAlgorithm</code>: Atmospheric refraction correction (default: <a href="../../refraction/#SolarPosition.Refraction.NoRefraction"><code>NoRefraction</code></a>)</li></ul><p><strong>Variables (Outputs)</strong></p><ul><li><code>azimuth(t)</code>: Solar azimuth angle in degrees (0° = North, 90° = East, 180° = South, 270° = West)</li><li><code>elevation(t)</code>: Solar elevation angle in degrees (angle above horizon, positive when sun is visible)</li><li><code>zenith(t)</code>: Solar zenith angle in degrees (angle from vertical, complementary to elevation: <code>zenith = 90° - elevation</code>)</li></ul><p><strong>Time Convention</strong></p><p>The simulation time <code>t</code> (accessed via <code>t_nounits</code>) is in <strong>seconds</strong> from the reference time <code>t0</code>. For example:</p><ul><li><code>t = 0</code> corresponds to <code>t0</code></li><li><code>t = 3600</code> corresponds to <code>t0 + 1 hour</code></li><li><code>t = 86400</code> corresponds to <code>t0 + 24 hours</code></li></ul><p><strong>Example</strong></p><pre><code class="language-julia hljs">using SolarPosition, ModelingToolkit
using ModelingToolkit: t_nounits as t, @named, mtkcompile
using Dates
using OrdinaryDiffEq: ODEProblem, solve

@named sun = SolarPositionBlock()
obs = Observer(51.5, -0.18, 15.0)
t0 = DateTime(2024, 6, 21, 12, 0, 0)

sys = mtkcompile(sun)
pmap = [
    sys.observer =&gt; obs,
    sys.t0 =&gt; t0,
    sys.algorithm =&gt; PSA(),
    sys.refraction =&gt; NoRefraction(),
]

prob = ODEProblem(sys, pmap, (0.0, 86400.0))
sol = solve(prob; saveat = 3600.0)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaAstro/SolarPosition.jl/blob/e5fd4b2e011976528d01291c01fd7c64abd93dca/src/SolarPosition.jl#L43-L102">source</a></section></details></article><h2 id="Composing-with-Other-Systems"><a class="docs-heading-anchor" href="#Composing-with-Other-Systems">Composing with Other Systems</a><a id="Composing-with-Other-Systems-1"></a><a class="docs-heading-anchor-permalink" href="#Composing-with-Other-Systems" title="Permalink"></a></h2><p>The real power of the ModelingToolkit extension comes from composing solar position with other physical systems.</p><h3 id="Example:-Solar-Panel-Power-Model"><a class="docs-heading-anchor" href="#Example:-Solar-Panel-Power-Model">Example: Solar Panel Power Model</a><a id="Example:-Solar-Panel-Power-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Solar-Panel-Power-Model" title="Permalink"></a></h3><pre><code class="language-julia hljs">using CairoMakie: Figure, Axis, lines!

# Create solar position block
@named sun = SolarPositionBlock()

# Create a simple solar panel model
@parameters begin
    area = 10.0           # Panel area (m²)
    efficiency = 0.2      # Panel efficiency (20%)
    dni_peak = 1000.0     # Peak direct normal irradiance (W/m²)
end

@variables begin
    irradiance(t) = 0.0   # Effective irradiance on panel (W/m²)
    power(t) = 0.0        # Power output (W)
end

# Simplified model: irradiance depends on sun elevation
# In reality, you&#39;d account for panel orientation, azimuth, etc.
eqs = [
    irradiance ~ dni_peak * max(0, sind(sun.elevation)),
    power ~ area * efficiency * irradiance,
]

# Compose the complete system
@named model = System(eqs, t; systems = [sun])
sys_model = mtkcompile(model)

# Set up and solve
obs = Observer(37.7749, -122.4194, 100.0)
t0 = DateTime(2024, 6, 21, 0, 0, 0)

pmap = [
    sys_model.sun.observer =&gt; obs,
    sys_model.sun.t0 =&gt; t0,
    sys_model.sun.algorithm =&gt; PSA(),
    sys_model.sun.refraction =&gt; NoRefraction(),
]

prob = ODEProblem(sys_model, pmap, (0.0, 86400.0))
sol = solve(prob; saveat = 600.0)  # Save every 10 minutes

# Plot results
fig = Figure(size = (1000, 400))

ax1 = Axis(fig[1, 1]; xlabel = &quot;Time (hours)&quot;, ylabel = &quot;Elevation (°)&quot;, title = &quot;Solar Elevation&quot;)
lines!(ax1, sol.t ./ 3600, sol[sys_model.sun.elevation])

ax2 = Axis(fig[1, 2]; xlabel = &quot;Time (hours)&quot;, ylabel = &quot;Power (W)&quot;, title = &quot;Solar Panel Power&quot;)
lines!(ax2, sol.t ./ 3600, sol[sys_model.power])

fig</code></pre><img src="daf7e67e.png" alt="Example block output"/><h3 id="Example:-Building-Thermal-Model-with-Solar-Gain"><a class="docs-heading-anchor" href="#Example:-Building-Thermal-Model-with-Solar-Gain">Example: Building Thermal Model with Solar Gain</a><a id="Example:-Building-Thermal-Model-with-Solar-Gain-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Building-Thermal-Model-with-Solar-Gain" title="Permalink"></a></h3><pre><code class="language-julia hljs">using CairoMakie: Figure, Axis, lines!
using ModelingToolkit: D_nounits as D

# Solar position component
@named sun = SolarPositionBlock()

# Building thermal model with solar gain
@parameters begin
    mass = 1000.0         # Thermal mass (kg)
    cp = 1000.0           # Specific heat capacity (J/(kg·K))
    U = 0.5               # Overall heat transfer coefficient (W/(m²·K))
    wall_area = 50.0      # Wall area (m²)
    window_area = 5.0     # Window area (m²)
    window_trans = 0.7    # Window transmittance
    T_outside = 20.0      # Outside temperature (°C)
    dni_peak = 800.0      # Peak solar irradiance (W/m²)
end

@variables begin
    T(t) = 20.0           # Room temperature (°C)
    Q_loss(t)             # Heat loss through walls (W)
    Q_solar(t)            # Solar heat gain (W)
    irradiance(t)         # Solar irradiance (W/m²)
end

eqs = [
    # Solar irradiance based on sun elevation
    irradiance ~ dni_peak * max(0, sind(sun.elevation)),
    # Solar heat gain through windows
    Q_solar ~ window_area * window_trans * irradiance,
    # Heat loss through walls
    Q_loss ~ U * wall_area * (T - T_outside),
    # Energy balance
    D(T) ~ (Q_solar - Q_loss) / (mass * cp),
]

@named building = System(eqs, t; systems = [sun])
sys_building = mtkcompile(building)

# Simulate
obs = Observer(40.7128, -74.0060, 100.0)  # New York City
t0 = DateTime(2024, 6, 21, 0, 0, 0)

pmap = [
    sys_building.sun.observer =&gt; obs,
    sys_building.sun.t0 =&gt; t0,
    sys_building.sun.algorithm =&gt; PSA(),
    sys_building.sun.refraction =&gt; NoRefraction(),
]

prob = ODEProblem(sys_building, pmap, (0.0, 86400.0))
sol = solve(prob; saveat = 600.0)

# Plot temperature evolution
fig = Figure(size = (1200, 400))

ax1 = Axis(fig[1, 1]; xlabel = &quot;Time (hours)&quot;, ylabel = &quot;Temperature (°C)&quot;, title = &quot;Room Temperature&quot;)
lines!(ax1, sol.t ./ 3600, sol[sys_building.T])

ax2 = Axis(fig[1, 2]; xlabel = &quot;Time (hours)&quot;, ylabel = &quot;Solar Gain (W)&quot;, title = &quot;Solar Heat Gain&quot;)
lines!(ax2, sol.t ./ 3600, sol[sys_building.Q_solar])

ax3 = Axis(fig[1, 3]; xlabel = &quot;Time (hours)&quot;, ylabel = &quot;Elevation (°)&quot;, title = &quot;Sun Elevation&quot;)
lines!(ax3, sol.t ./ 3600, sol[sys_building.sun.elevation])

fig</code></pre><img src="27151519.png" alt="Example block output"/><h2 id="Implementation-Details"><a class="docs-heading-anchor" href="#Implementation-Details">Implementation Details</a><a id="Implementation-Details-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation-Details" title="Permalink"></a></h2><p>The extension works by registering the <a href="../../reference/#SolarPosition.Positioning.solar_position"><code>solar_position</code></a> function and helper functions as symbolic operations in ModelingToolkit. The actual solar position calculation happens during ODE solving, with the simulation time <code>t</code> being converted to a <a href="https://docs.julialang.org/en/v1/stdlib/Dates/#Dates.DateTime"><code>DateTime</code></a> relative to the reference time <code>t0</code>.</p><h2 id="Limitations"><a class="docs-heading-anchor" href="#Limitations">Limitations</a><a id="Limitations-1"></a><a class="docs-heading-anchor-permalink" href="#Limitations" title="Permalink"></a></h2><p>The solar position calculation is treated as a black-box function by MTK&#39;s symbolic engine, so its internals cannot be symbolically simplified.</p><h2 id="See-Also"><a class="docs-heading-anchor" href="#See-Also">See Also</a><a id="See-Also-1"></a><a class="docs-heading-anchor-permalink" href="#See-Also" title="Permalink"></a></h2><ul><li><a href="../../positioning/#solar-positioning-algorithms">Solar Positioning</a> - Available positioning algorithms</li><li><a href="../../refraction/#refraction-correction">Refraction Correction</a> - Atmospheric refraction methods</li><li><a href="https://docs.sciml.ai/ModelingToolkit/stable/">ModelingToolkit.jl Documentation</a> - MTK framework documentation</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../parallel/">« Parallel Computing with OhMyThreads.jl</a><a class="docs-footer-nextpage" href="../new-algorithm/">Adding a New Solar Position Algorithm »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Thursday 4 December 2025 20:04">Thursday 4 December 2025</span>. Using Julia version 1.12.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
